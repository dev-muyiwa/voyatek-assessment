<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WS Test Client</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; background: #0b1220; color: #e6e9ef; }
      h1 { font-size: 18px; margin: 0 0 12px; }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      .card { background: #101827; border: 1px solid #1f2a44; border-radius: 8px; padding: 12px; }
      label { display: block; font-size: 12px; opacity: .8; margin: 8px 0 4px; }
      input, textarea, select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #2a385d; background: #0e1626; color: #e6e9ef; }
      button { background: #2563eb; color: white; border: 0; border-radius: 6px; padding: 8px 12px; cursor: pointer; }
      button.secondary { background: #334155; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .log { height: 320px; overflow: auto; background: #0a0f1a; border: 1px solid #1f2a44; padding: 8px; border-radius: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
      .pill { padding: 2px 6px; border-radius: 999px; font-size: 11px; border: 1px solid #1f2a44; background: #0e1626; }
    </style>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" integrity="sha384-1o0C4oQ8QyYw6Qd0b2nP9B0N2c0cZKzQ6Cj+FQmGm6f3x4fXkWq3R2f7c6y1h0vY" crossorigin="anonymous"></script>
  </head>
  <body>
    <h1>Realtime Rooms â€” Test Client <span id="status" class="pill">disconnected</span></h1>
    <div class="grid">
      <div class="card">
        <div class="row">
          <div style="flex:1">
            <label>Base URL</label>
            <input id="baseUrl" value="http://localhost:3000" />
          </div>
          <div>
            <label>Port</label>
            <input id="port" style="width:100px" value="3000" />
          </div>
        </div>
        <label>JWT Access Token</label>
        <input id="token" placeholder="paste access token" />
        <div class="row" style="margin-top:8px">
          <button id="connectBtn">Connect</button>
          <button id="disconnectBtn" class="secondary">Disconnect</button>
        </div>
        <hr style="border-color:#1f2a44; margin:12px 0" />
        <label>Room ID</label>
        <input id="roomId" placeholder="room uuid" />
        <div class="row" style="margin-top:8px">
          <button id="joinBtn">Join Room</button>
          <button id="leaveBtn" class="secondary">Leave Room</button>
        </div>
        <hr style="border-color:#1f2a44; margin:12px 0" />
        <label>Message</label>
        <textarea id="message" rows="3" placeholder="Hello world!"></textarea>
        <div class="row" style="margin-top:8px">
          <button id="sendBtn">Send</button>
          <button id="typingOnBtn" class="secondary">Typing On</button>
          <button id="typingOffBtn" class="secondary">Typing Off</button>
        </div>
        <hr style="border-color:#1f2a44; margin:12px 0" />
        <label>Message ID (for read)</label>
        <input id="messageId" placeholder="message uuid" />
        <div class="row" style="margin-top:8px">
          <button id="readBtn" class="secondary">Mark Read</button>
        </div>
        <hr style="border-color:#1f2a44; margin:12px 0" />
        <div class="row">
          <button id="fetchMessagesBtn" class="secondary">GET /rooms/:roomId/messages</button>
          <button id="membersBtn" class="secondary">GET /rooms/:roomId/members</button>
          <button id="presenceBtn" class="secondary">GET /rooms/:roomId/presence</button>
        </div>
      </div>

      <div class="card">
        <label>Logs</label>
        <div id="log" class="log"></div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const logEl = $("log");
      const statusEl = $("status");
      let socket = null;

      function log(type, data) {
        const time = new Date().toISOString();
        const line = document.createElement('div');
        line.textContent = `[${time}] ${type}: ${typeof data === 'string' ? data : JSON.stringify(data)}`;
        logEl.appendChild(line);
        logEl.scrollTop = logEl.scrollHeight;
      }

      function getBase() {
        const base = $("baseUrl").value.trim().replace(/\/$/, '');
        return base || 'http://localhost:3000';
      }

      function authHeaders() {
        const token = $("token").value.trim();
        return token ? { Authorization: `Bearer ${token}` } : {};
      }

      $("connectBtn").onclick = () => {
        const base = getBase();
        const token = $("token").value.trim();
        if (!token) return log('error', 'Provide JWT token');
        if (socket?.connected) return log('info', 'Already connected');

        socket = io(base, { auth: { token }, transports: ['websocket'] });
        socket.on('connect', () => { statusEl.textContent = 'connected'; log('socket', { id: socket.id, connected: true }); });
        socket.on('connect_error', (e) => { statusEl.textContent = 'error'; log('connect_error', e.message || e); });
        socket.on('disconnect', (reason) => { statusEl.textContent = 'disconnected'; log('disconnect', reason); });
        socket.on('receive_message', (m) => log('receive_message', m));
        socket.on('joined_room', (d) => log('joined_room', d));
        socket.on('join_room_error', (e) => log('join_room_error', e));
        socket.on('typing', (d) => log('typing', d));
        socket.on('user_status', (d) => log('user_status', d));
        socket.on('user_joined', (d) => log('user_joined', d));
        socket.on('user_left', (d) => log('user_left', d));
        socket.on('message_receipt', (d) => log('message_receipt', d));
        socket.on('messages_read', (d) => log('messages_read', d));
        socket.on('message_error', (e) => log('message_error', e));
      };

      $("disconnectBtn").onclick = () => { if (socket) { socket.disconnect(); } };

      $("joinBtn").onclick = () => {
        const roomId = $("roomId").value.trim();
        if (!socket?.connected) return log('error', 'Connect first');
        if (!roomId) return log('error', 'Room ID required');
        socket.emit('join_room', { roomId });
      };

      $("leaveBtn").onclick = () => {
        const roomId = $("roomId").value.trim();
        if (!socket?.connected) return log('error', 'Connect first');
        if (!roomId) return log('error', 'Room ID required');
        socket.emit('leave_room', { roomId });
      };

      $("sendBtn").onclick = () => {
        const roomId = $("roomId").value.trim();
        const content = $("message").value;
        if (!socket?.connected) return log('error', 'Connect first');
        if (!roomId) return log('error', 'Room ID required');
        socket.emit('send_message', { roomId, content });
      };

      $("typingOnBtn").onclick = () => {
        const roomId = $("roomId").value.trim();
        if (!socket?.connected) return log('error', 'Connect first');
        socket.emit('typing', { roomId, isTyping: true });
      };

      $("typingOffBtn").onclick = () => {
        const roomId = $("roomId").value.trim();
        if (!socket?.connected) return log('error', 'Connect first');
        socket.emit('typing', { roomId, isTyping: false });
      };

      $("readBtn").onclick = () => {
        const roomId = $("roomId").value.trim();
        const messageId = $("messageId").value.trim();
        if (!socket?.connected) return log('error', 'Connect first');
        if (!messageId) return log('error', 'Message ID required');
        socket.emit('message_read', { roomId, messageId });
      };

      async function get(path) {
        const base = getBase();
        const res = await fetch(`${base}${path}`, { headers: { 'Content-Type': 'application/json', ...authHeaders() }});
        const text = await res.text();
        try { return JSON.parse(text); } catch { return text; }
      }

      $("fetchMessagesBtn").onclick = async () => {
        const roomId = $("roomId").value.trim();
        if (!roomId) return log('error', 'Room ID required');
        const data = await get(`/rooms/${roomId}/messages?page=1&pageSize=20`);
        log('GET /messages', data);
      };

      $("membersBtn").onclick = async () => {
        const roomId = $("roomId").value.trim();
        if (!roomId) return log('error', 'Room ID required');
        const data = await get(`/rooms/${roomId}/members`);
        log('GET /members', data);
      };

      $("presenceBtn").onclick = async () => {
        const roomId = $("roomId").value.trim();
        if (!roomId) return log('error', 'Room ID required');
        const data = await get(`/rooms/${roomId}/presence`);
        log('GET /presence', data);
      };
    </script>
  </body>
  </html>

